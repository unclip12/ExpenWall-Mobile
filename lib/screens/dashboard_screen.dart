import 'package:flutter/material.dart';
import 'dart:ui';
import '../models/transaction.dart';
import '../models/budget.dart';
import '../utils/currency_formatter.dart';
import '../widgets/glass_card.dart';
import '../widgets/transaction_item_widget.dart';

class DashboardScreen extends StatefulWidget {
  final List<Transaction> transactions;
  final List<Budget> budgets;

  const DashboardScreen({
    super.key,
    required this.transactions,
    required this.budgets,
  });

  @override
  State<DashboardScreen> createState() => _DashboardScreenState();
}

class _DashboardScreenState extends State<DashboardScreen>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _fadeAnimation;
  late Animation<Offset> _slideAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 800),
      vsync: this,
    );
    _fadeAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _controller, curve: Curves.easeOut),
    );
    _slideAnimation = Tween<Offset>(\n      begin: const Offset(0, 0.1),\n      end: Offset.zero,\n    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic));\n    _controller.forward();\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  double get totalSpent => widget.transactions\n      .where((t) => t.type == TransactionType.expense)\n      .fold(0.0, (sum, t) => sum + t.amount);\n\n  double get totalIncome => widget.transactions\n      .where((t) => t.type == TransactionType.income)\n      .fold(0.0, (sum, t) => sum + t.amount);\n\n  double get netBalance => totalIncome - totalSpent;\n\n  List<Transaction> get recentTransactions {\n    final sorted = List<Transaction>.from(widget.transactions);\n    sorted.sort((a, b) => b.date.compareTo(a.date));\n    return sorted.take(5).toList();\n  }\n\n  Map<Category, double> get categoryData {\n    final Map<Category, double> data = {};\n    for (var tx in widget.transactions) {\n      if (tx.type == TransactionType.expense) {\n        data[tx.category] = (data[tx.category] ?? 0) + tx.amount;\n      }\n    }\n    return data;\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final isDark = Theme.of(context).brightness == Brightness.dark;\n    \n    return Scaffold(\n      backgroundColor: Colors.transparent,\n      body: FadeTransition(\n        opacity: _fadeAnimation,\n        child: SlideTransition(\n          position: _slideAnimation,\n          child: RefreshIndicator(\n            onRefresh: () async {\n              await Future.delayed(const Duration(seconds: 1));\n            },\n            color: Theme.of(context).colorScheme.primary,\n            child: ListView(\n              padding: const EdgeInsets.all(20),\n              physics: const BouncingScrollPhysics(),\n              children: [\n                const SizedBox(height: 10),\n                _buildWelcomeSection(isDark),\n                const SizedBox(height: 24),\n                _buildSummaryCards(),\n                const SizedBox(height: 24),\n                _buildCategoryBreakdown(isDark),\n                const SizedBox(height: 24),\n                _buildRecentActivity(isDark),\n                const SizedBox(height: 80), // Bottom padding for nav bar\n              ],\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n\n  Widget _buildWelcomeSection(bool isDark) {\n    return Column(\n      crossAxisAlignment: CrossAxisAlignment.start,\n      children: [\n        Text(\n          'Welcome back',\n          style: TextStyle(\n            fontSize: 16,\n            color: isDark ? Colors.grey[300] : Colors.grey[700],\n            fontWeight: FontWeight.w500,\n          ),\n        ),\n        const SizedBox(height: 4),\n        Text(\n          'Financial Overview',\n          style: TextStyle(\n            fontSize: 28,\n            fontWeight: FontWeight.bold,\n            // ✅ FIX: Ensure visible text in both modes\n            color: isDark ? Colors.white : Colors.black87,\n          ),\n        ),\n      ],\n    );\n  }\n\n  Widget _buildSummaryCards() {\n    return Column(\n      children: [\n        Row(\n          children: [\n            Expanded(\n              child: _buildSummaryCard(\n                'Income',\n                totalIncome,\n                Icons.arrow_downward,\n                const Color(0xFF10B981),\n                const Color(0xFFD1FAE5),\n              ),\n            ),\n            const SizedBox(width: 16),\n            Expanded(\n              child: _buildSummaryCard(\n                'Expense',\n                totalSpent,\n                Icons.arrow_upward,\n                const Color(0xFFEF4444),\n                const Color(0xFFFEE2E2),\n              ),\n            ),\n          ],\n        ),\n        const SizedBox(height: 16),\n        _buildNetBalanceCard(),\n      ],\n    );\n  }\n\n  Widget _buildSummaryCard(\n    String title,\n    double amount,\n    IconData icon,\n    Color primaryColor,\n    Color backgroundColor,\n  ) {\n    return GlassCard(\n      child: Padding(\n        padding: const EdgeInsets.all(20),\n        child: Column(\n          crossAxisAlignment: CrossAxisAlignment.start,\n          children: [\n            Row(\n              mainAxisAlignment: MainAxisAlignment.spaceBetween,\n              children: [\n                Container(\n                  padding: const EdgeInsets.all(10),\n                  decoration: BoxDecoration(\n                    color: backgroundColor.withOpacity(0.8),\n                    borderRadius: BorderRadius.circular(12),\n                  ),\n                  child: Icon(icon, color: primaryColor, size: 20),\n                ),\n                Text(\n                  title.toUpperCase(),\n                  style: TextStyle(\n                    fontSize: 10,\n                    fontWeight: FontWeight.bold,\n                    color: Colors.grey[600],\n                    letterSpacing: 1,\n                  ),\n                ),\n              ],\n            ),\n            const SizedBox(height: 12),\n            Text(\n              CurrencyFormatter.format(amount),\n              style: TextStyle(\n                fontSize: 24,\n                fontWeight: FontWeight.bold,\n                // ✅ FIX: Ensure visible number in dark mode\n                color: Theme.of(context).textTheme.bodyLarge?.color,\n              ),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  Widget _buildNetBalanceCard() {\n    return Container(\n      decoration: BoxDecoration(\n        gradient: const LinearGradient(\n          colors: [Color(0xFF6366F1), Color(0xFF8B5CF6)],\n          begin: Alignment.topLeft,\n          end: Alignment.bottomRight,\n        ),\n        borderRadius: BorderRadius.circular(24),\n        boxShadow: [\n          BoxShadow(\n            color: const Color(0xFF6366F1).withOpacity(0.3),\n            blurRadius: 20,\n            offset: const Offset(0, 10),\n          ),\n        ],\n      ),\n      child: Stack(\n        children: [\n          Positioned(\n            top: -50,\n            right: -50,\n            child: Container(\n              width: 150,\n              height: 150,\n              decoration: BoxDecoration(\n                shape: BoxShape.circle,\n                color: Colors.white.withOpacity(0.1),\n              ),\n            ),\n          ),\n          Padding(\n            padding: const EdgeInsets.all(24),\n            child: Column(\n              crossAxisAlignment: CrossAxisAlignment.start,\n              children: [\n                Row(\n                  mainAxisAlignment: MainAxisAlignment.spaceBetween,\n                  children: [\n                    Container(\n                      padding: const EdgeInsets.all(12),\n                      decoration: BoxDecoration(\n                        color: Colors.white.withOpacity(0.2),\n                        borderRadius: BorderRadius.circular(14),\n                      ),\n                      child: const Icon(\n                        Icons.account_balance_wallet_rounded,\n                        color: Colors.white,\n                        size: 24,\n                      ),\n                    ),\n                    Text(\n                      'NET BALANCE',\n                      style: TextStyle(\n                        fontSize: 11,\n                        fontWeight: FontWeight.bold,\n                        color: Colors.white.withOpacity(0.8),\n                        letterSpacing: 1,\n                      ),\n                    ),\n                  ],\n                ),\n                const SizedBox(height: 16),\n                Text(\n                  CurrencyFormatter.format(netBalance),\n                  style: const TextStyle(\n                    fontSize: 36,\n                    fontWeight: FontWeight.bold,\n                    color: Colors.white,\n                  ),\n                ),\n              ],\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n\n  Widget _buildCategoryBreakdown(bool isDark) {\n    if (categoryData.isEmpty) {\n      return GlassCard(\n        child: Padding(\n          padding: const EdgeInsets.all(32),\n          child: Center(\n            child: Column(\n              children: [\n                Icon(Icons.pie_chart_outline, size: 48, color: Colors.grey[400]),\n                const SizedBox(height: 12),\n                Text(\n                  'No expenses yet',\n                  style: TextStyle(color: Colors.grey[600]),\n                ),\n              ],\n            ),\n          ),\n        ),\n      );\n    }\n\n    return GlassCard(\n      child: Padding(\n        padding: const EdgeInsets.all(20),\n        child: Column(\n          crossAxisAlignment: CrossAxisAlignment.start,\n          children: [\n            Text(\n              'Spending by Category',\n              style: TextStyle(\n                fontSize: 18,\n                fontWeight: FontWeight.bold,\n                color: isDark ? Colors.white : Colors.black87,\n              ),\n            ),\n            const SizedBox(height: 20),\n            ...categoryData.entries.map((entry) {\n              final percentage = (entry.value / totalSpent * 100);\n              return Padding(\n                padding: const EdgeInsets.only(bottom: 16),\n                child: Column(\n                  crossAxisAlignment: CrossAxisAlignment.start,\n                  children: [\n                    Row(\n                      mainAxisAlignment: MainAxisAlignment.spaceBetween,\n                      children: [\n                        Text(\n                          entry.key.label,\n                          style: TextStyle(\n                            fontSize: 14,\n                            fontWeight: FontWeight.w600,\n                            color: isDark ? Colors.white70 : Colors.black87,\n                          ),\n                        ),\n                        Text(\n                          CurrencyFormatter.format(entry.value),\n                          style: TextStyle(\n                            fontSize: 14,\n                            fontWeight: FontWeight.bold,\n                            color: Theme.of(context).colorScheme.primary,\n                          ),\n                        ),\n                      ],\n                    ),\n                    const SizedBox(height: 8),\n                    ClipRRect(\n                      borderRadius: BorderRadius.circular(8),\n                      child: LinearProgressIndicator(\n                        value: percentage / 100,\n                        backgroundColor: isDark ? Colors.grey[800] : Colors.grey[200],\n                        color: Theme.of(context).colorScheme.primary,\n                        minHeight: 8,\n                      ),\n                    ),\n                  ],\n                ),\n              );\n            }).toList(),\n          ],\n        ),\n      ),\n    );\n  }\n\n  Widget _buildRecentActivity(bool isDark) {\n    return GlassCard(\n      child: Padding(\n        padding: const EdgeInsets.all(20),\n        child: Column(\n          crossAxisAlignment: CrossAxisAlignment.start,\n          children: [\n            Text(\n              'Recent Activity',\n              style: TextStyle(\n                fontSize: 18,\n                fontWeight: FontWeight.bold,\n                color: isDark ? Colors.white : Colors.black87,\n              ),\n            ),\n            const SizedBox(height: 16),\n            if (recentTransactions.isEmpty)\n              Padding(\n                padding: const EdgeInsets.all(32),\n                child: Center(\n                  child: Column(\n                    children: [\n                      Icon(Icons.receipt_long_outlined,\n                          size: 48, color: Colors.grey[400]),\n                      const SizedBox(height: 12),\n                      Text(\n                        'No transactions yet',\n                        style: TextStyle(color: Colors.grey[600]),\n                      ),\n                    ],\n                  ),\n                ),\n              )\n            else\n              ...recentTransactions.map(\n                (tx) => TransactionItemWidget(\n                  transaction: tx,\n                  onTap: () {},\n                ),\n              ),\n          ],\n        ),\n      ),\n    );\n  }\n}\n